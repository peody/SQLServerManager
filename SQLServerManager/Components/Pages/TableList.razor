@page "/tables"
@using System.Data
@inject ITableService TableService
@inject IDatabaseService DatabaseService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="container-fluid">
    <h3>Database Tables</h3>
    <!-- Database Selection -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="form-group">
                <label for="databaseSelect" class="form-label">Select Database:</label>
                <select id="databaseSelect" class="form-select" @bind="selectedDatabase" @bind:after="LoadTables">
                    <option value="">-- Select Database --</option>
                    @if (databases != null)
                    {
                        @foreach (var db in databases)
                        {
                            <option value="@db">@db</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="col-md-8">
            @if (!string.IsNullOrEmpty(selectedDatabase))
            {
                <button class="btn btn-success" @onclick="ShowCreateTableModal">
                    <i class="fas fa-plus"></i> Create New Table
                </button>
            }
        </div>
    </div>
    @if (loading)
    {
        <div class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (tables != null && selectedDatabase != null)
    {
        <!-- Tables List -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Schema</th>
                        <th>Table Name</th>
                        <th>Rows</th>
                        <th>Size</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var table in tables)
                    {
                        <tr>
                            <td>@table.Schema</td>
                            <td>@table.Name</td>
                            <td>@table.RowCount.ToString("N0")</td>
                            <td>@((table.SizeKB / 1024.0).ToString("N2")) MB</td>
                            <td>@table.CreateDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td class="table-actions">
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-sm" @onclick="() => ViewTableData(table)">
                                        <i class="fas fa-table"></i> Data
                                    </button>
                                    <button class="btn btn-info btn-sm" @onclick="() => ShowColumnsModal(table)">
                                        <i class="fas fa-columns"></i> Columns
                                    </button>
                                    <button class="btn btn-danger btn-sm" @onclick="() => ConfirmAndDeleteTable(table)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Data of table-->
        @if (tableData != null && DataModal)
        {
            <!-- Table Data View -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>@selectedTable?.Schema.@selectedTable?.Name Data</h5>
                    <!--add records-->
                    <button class="btn btn-success" @onclick="InitializeAddRecord">
                        <i class="fas fa-plus"></i> Add New Record
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    @foreach (var column in tableData.Columns)
                                    {
                                        <th>
                                            @column
                                            <button class="btn btn-link btn-sm" @onclick="() => SortBy(column)">
                                                <i class="fas fa-sort"></i>
                                            </button>
                                        </th>
                                    }
                                    <th>Actions</th><!--them phan nay-->
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var row in tableData.Rows)
                                {
                                    <tr>
                                        @foreach (var cell in row)
                                        {
                                            <td>@(cell?.ToString() ?? "NULL")</td>
                                        }
                                        <!-- them phan nay-->
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-primary btn-sm" @onclick="() => InitializeEditRecord(row)">Edit

                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm"
                                                        @onclick="() => DeleteRecord(ConvertRowToDictionary(row, tableData.Columns))">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav>
                        <ul class="pagination justify-content-center">
                            @{
                                var totalPages = (int)Math.Ceiling(tableData.TotalRows / (double)pageSize);
                                for (int i = 1; i <= totalPages; i++)
                                {
                                    var pageNumber = i;
                                    <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                                        <button class="page-link" @onclick="() => LoadPage(pageNumber)">@pageNumber</button>
                                    </li>
                                }
                            }
                        </ul>
                    </nav>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseDataModals">Close</button>
            </div>
        }
    }
    <!-- Create Table Modal -->
    @if (showCreateModal)
    {
        <div class="modal" style="display: block" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create New Table</h5>
                        <button type="button" class="btn-close" @onclick="CloseModals"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Schema:</label>
                                    <input type="text" class="form-control" @bind="newTable.Schema" placeholder="Default: dbo"/>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Table Name:</label>
                                    <input type="text" class="form-control" @bind="newTable.Name" required/>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Columns:</label>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Data Type</th>
                                            <th>Length</th>
                                            <th>Primary Key</th>
                                            <th>Nullable</th>
                                            <th>Identity</th>
                                            <th>Foreign Key</th>
                                            <th>FK Reference</th>
                                            <th>Default</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var column in newTable.Columns)
                                        {
                                            <tr>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           @bind="column.Name" />
                                                </td>
                                                <td>
                                                    <select class="form-select form-select-sm"
                                                            value="@column.DataType"
                                                            @onchange="@(e => OnDataTypeChanged(column, e.Value.ToString()))">
                                                        @foreach (var type in dataTypes)
                                                        {
                                                            <option value="@type">@type</option>
                                                        }
                                                    </select>
                                                </td>

                                                <td>
                                                    @if (lengthRequiredTypes.Contains(column.DataType?.ToLower()))
                                                    {
                                                        <input type="number" class="form-control form-control-sm"
                                                               @bind="column.MaxLength" />
                                                    }
                                                    else
                                                    {
                                                        <input type="number" class="form-control form-control-sm"
                                                               disabled
                                                               value="" />
                                                    }
                                                </td>

                                                <td>
                                                    <input type="checkbox" class="form-check-input"
                                                           @bind="column.IsPrimaryKey" />
                                                </td>
                                                <td>
                                                    <input type="checkbox" class="form-check-input"
                                                           @bind="column.IsNullable" />
                                                </td>
                                                <td>
                                                    <input type="checkbox" class="form-check-input"
                                                           @bind="column.IsIdentity" />
                                                </td>
                                                <td>
                                                    <input type="checkbox" class="form-check-input"
                                                           @bind="column.IsForeignKey"
                                                           @onclick="() => OnForeignKeyChanged(column)" />
                                                </td>
                                                <td>
                                                    @if (column.IsForeignKey)
                                                    {
                                                        <div class="d-flex gap-2">
                                                            <select class="form-select form-select-sm" @bind="column.ForeignKeyTable">
                                                                <option value="">Select Table</option>
                                                                @if (tables != null)
                                                                {
                                                                    @foreach (var table in tables)
                                                                    {
                                                                        <option value="@($"{table.Schema}.{table.Name}")">@($"{table.Schema}.{table.Name}")</option>
                                                                    }
                                                                }
                                                            </select>
                                                            @if (!string.IsNullOrEmpty(column.ForeignKeyTable))
                                                            {
                                                                <select class="form-select form-select-sm" @bind="column.ForeignKeyColumn">
                                                                    <option value="">Select Column</option>
                                                                    @foreach (var fkColumn in GetForeignKeyColumns(column.ForeignKeyTable))
                                                                    {
                                                                        <option value="@fkColumn.Name">@fkColumn.Name</option>
                                                                    }
                                                                </select>
                                                            }
                                                        </div>
                                                    }
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm"
                                                           @bind="column.DefaultValue" />
                                                </td>
                                                <td>
                                                    <button class="btn btn-danger btn-sm"
                                                            @onclick="() => RemoveColumn(column)">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>

                            </div>
                            <button class="btn btn-secondary btn-sm" @onclick="AddColumn">
                                <i class="fas fa-plus"></i> Add Column
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="ValidateAndCreateTable">Create</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop"></div>
        
    }
    <!-- Columns Modal -->
    @if (showColumnsModal)
    {
        <div class="modal fade show" style="display: block" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Columns - @selectedTable?.Schema.@selectedTable?.Name</h5>
                        <button type="button" class="btn-close" @onclick="CloseModals"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Add Column Button -->
                        <button class="btn btn-success mb-3" @onclick="InitializeAddColumn">
                            <i class="fas fa-plus"></i> Add New Column
                        </button>

                        @if (isAddingColumn || isEditingColumn)
                        {
                            <div class="card mb-3">
                                <div class="card-header">
                                    @(isAddingColumn ? "Add New Column" : "Edit Column")
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Column Name:</label>
                                                <input type="text" class="form-control" @bind="editingColumn.Name" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Data Type:</label>
                                                <select class="form-select" @bind="editingColumn.DataType">
                                                    @foreach (var type in dataTypes)
                                                    {
                                                        <option value="@type">@type</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label>Length:</label>
                                                <input type="number" class="form-control"
                                                       @bind="editingColumn.MaxLength"
                                                       disabled="@(!lengthRequiredTypes.Contains(editingColumn.DataType?.ToLower()))" />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mt-4">
                                                <input type="checkbox" class="form-check-input" @bind="editingColumn.IsNullable" />
                                                <label class="form-check-label">Nullable</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label>Default Value:</label>
                                                <input type="text" class="form-control" @bind="editingColumn.DefaultValue" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" @onclick="SaveColumnChanges">Save</button>
                                        <button class="btn btn-secondary" @onclick="CancelColumnEdit">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (tableColumns != null && tableColumns.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Data Type</th>
                                            <th>Length</th>
                                            <th>Nullable</th>
                                            <th>Default Value</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var column in tableColumns)
                                        {
                                            <tr>
                                                <td>@column.Name</td>
                                                <td>@column.DataType</td>
                                                <td>@column.MaxLength</td>
                                                <td>@(column.IsNullable ? "Yes" : "No")</td>
                                                <td>@column.DefaultValue</td>
                                                <td>
                                                    <button class="btn btn-primary btn-sm" @onclick="() => InitializeEditColumn(column)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDeleteColumn(column)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModals">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
    <!-- Record Modal -->
    <!-- them phan nay-->
    @if (showRecordModal && tableColumns != null)
    {
        <div class="modal fade show" style="display: block" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@(isEditingRecord ? "Edit" : "Add") Record</h5>
                        <button type="button" class="btn-close" @onclick="() => showRecordModal = false"></button>
                    </div>
                    <div class="modal-body">
                        @foreach (var column in tableColumns)
                        {
                            <div class="form-group mb-3">
                                <label>@column.Name</label>
                                <input type="text" class="form-control"
                                       value="@(editingRecord.ContainsKey(column.Name) ? editingRecord[column.Name]?.ToString() : "")"
                                       @onchange="@(e => editingRecord[column.Name] = e.Value?.ToString())" />
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="() => showRecordModal = false">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="SaveRecord">Save</button>
                    </div>
                </div>
            </div>
        </div>
    }


</div>

@code {
    // Danh sách cơ sở dữ liệu hiện có
    private List<string> databases;

    // Danh sách các bảng trong cơ sở dữ liệu đã chọn
    private List<TableInfo> tables;

    // Tên cơ sở dữ liệu hiện tại được chọn
    private string selectedDatabase;

    // Thông tin bảng hiện tại được chọn
    private TableInfo selectedTable;

    // Danh sách các cột trong bảng đã chọn
    private List<ColumnInfo> tableColumns;

    // Kết quả truy vấn dữ liệu bảng
    private QueryResult tableData;

    // Trạng thái đang tải dữ liệu
    private bool loading;

    // Trạng thái hiển thị modal tạo bảng
    private bool showCreateModal;

    // Trạng thái hiển thị modal cột
    private bool showColumnsModal;

    // Thông tin bảng mới đang được tạo
    private TableInfo newTable = new() { Schema = "dbo", Columns = new List<ColumnInfo>() };

    // Trang hiện tại trong phân trang
    private int currentPage = 1;

    // Số lượng bản ghi hiển thị trên mỗi trang
    private int pageSize = 50;

    // Cột hiện tại để sắp xếp dữ liệu
    private string currentOrderBy;

    // Trạng thái hiển thị modal dữ liệu
    private bool DataModal = false;

    // Danh sách các kiểu dữ liệu có thể cho cột
    private readonly List<string> dataTypes = new()
{
    "int",
    "bigint",
    "smallint",
    "tinyint",
    "varchar",
    "nvarchar",
    "char",
    "nchar",
    "datetime",
    "datetime2",
    "date",
    "time",
    "bit",
    "decimal",
    "float",
    "money",
    "text",
    "ntext",
    "binary",
    "varbinary",
    "uniqueidentifier"
};

    // Trạng thái chỉnh sửa cột
    private bool isEditingColumn = false;

    // Trạng thái thêm cột
    private bool isAddingColumn = false;

    // Cột đang được chỉnh sửa
    private ColumnInfo editingColumn = new();

    // Tên cột gốc để lưu khi chỉnh sửa
    private string originalColumnName;

    // Danh sách các kiểu dữ liệu yêu cầu độ dài
    private readonly List<string> lengthRequiredTypes = new()
{
    "varchar", "nvarchar", "char", "nchar", "binary", "varbinary"
};

    // Phương thức xử lý khi kiểu dữ liệu của cột thay đổi
    private void OnDataTypeChanged(ColumnInfo column, string newDataType)
    {
        column.DataType = newDataType; // Cập nhật kiểu dữ liệu
                                       // Nếu kiểu dữ liệu không yêu cầu độ dài, đặt độ dài tối đa về 0
        if (!lengthRequiredTypes.Contains(newDataType.ToLower()))
        {
            column.MaxLength = 0;
        }
    }

    // Phương thức khởi tạo khi component được khởi tạo
    protected override async Task OnInitializedAsync()
    {
        try
        {
            loading = true; // Bắt đầu quá trình tải
            databases = await DatabaseService.GetDatabasesAsync(); // Tải danh sách cơ sở dữ liệu
        }
        catch (Exception ex)
        {
            // Hiển thị thông báo lỗi nếu có
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading databases: {ex.Message}");
        }
        finally
        {
            loading = false; // Kết thúc quá trình tải
        }
    }

    // Phương thức tải danh sách bảng từ cơ sở dữ liệu đã chọn
    private async Task LoadTables()
    {
        if (string.IsNullOrEmpty(selectedDatabase)) // Nếu chưa chọn cơ sở dữ liệu
            return;

        try
        {
            loading = true; // Bắt đầu quá trình tải
            tables = await TableService.GetTablesAsync(selectedDatabase); // Tải danh sách bảng
        }
        catch (Exception ex)
        {
            // Hiển thị thông báo lỗi nếu có
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading tables: {ex.Message}");
        }
        finally
        {
            loading = false; // Kết thúc quá trình tải
        }
    }

    // Phương thức hiển thị dữ liệu của bảng đã chọn
    private async Task ViewTableData(TableInfo table)
    {
        try
        {
            selectedTable = table; // Lưu bảng đã chọn
            currentPage = 1; // Đặt trang hiện tại về 1
            currentOrderBy = null; // Đặt thứ tự sắp xếp về null
            DataModal = true; // Hiển thị modal dữ liệu
            await LoadTableData(); // Tải dữ liệu bảng
        }
        catch (Exception ex)
        {
            // Hiển thị thông báo lỗi nếu có
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading table data: {ex.Message}");
        }
    }

    // Phương thức tải dữ liệu cho trang hiện tại
    private async Task LoadPage(int page)
    {
        currentPage = page; // Đặt trang hiện tại
        await LoadTableData(); // Tải dữ liệu bảng
    }

    // Phương thức tải dữ liệu của bảng đã chọn
    private async Task LoadTableData()
    {
        try
        {
            loading = true; // Bắt đầu quá trình tải
            tableData = await TableService.QueryTableDataAsync(
                selectedDatabase,
                selectedTable.Schema,
                selectedTable.Name,
                currentPage,
                pageSize,
                currentOrderBy // Truyền thông tin sắp xếp
            );
        }
        catch (Exception ex)
        {
            // Hiển thị thông báo lỗi nếu có
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading table data: {ex.Message}");
        }
        finally
        {
            loading = false; // Kết thúc quá trình tải
        }
    }

    // Phương thức hiển thị modal cột cho bảng đã chọn
    private async Task ShowColumnsModal(TableInfo table)
    {
        try
        {
            loading = true; // Bắt đầu quá trình tải
            selectedTable = table; // Lưu bảng đã chọn
            if (table != null)
            {
                // Tải danh sách cột cho bảng đã chọn
                tableColumns = await TableService.GetColumnsAsync(
                    selectedDatabase,
                    table.Schema,
                    table.Name
                );
            }
            showColumnsModal = true; // Hiển thị modal cột
        }
        catch (Exception ex)
        {
            // Hiển thị thông báo lỗi nếu có
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading columns: {ex.Message}");
        }
        finally
        {
            loading = false; // Kết thúc quá trình tải
            StateHasChanged(); // Cập nhật trạng thái UI
        }
    }

    // Phương thức hiển thị modal tạo bảng
    private void ShowCreateTableModal()
    {
        newTable = new TableInfo
            {
                Schema = "dbo", // Đặt schema mặc định
                Columns = new List<ColumnInfo>
        {
            new ColumnInfo() // Thêm cột đầu tiên mặc định
        }
            };
        showCreateModal = true; // Hiển thị modal tạo bảng
    }

    // Phương thức thêm cột mới vào bảng
    private void AddColumn()
    {
        newTable.Columns.Add(new ColumnInfo()); // Thêm cột mới
    }

    // Phương thức xóa cột khỏi bảng
    private void RemoveColumn(ColumnInfo column)
    {
        newTable.Columns.Remove(column); // Xóa cột
    }

    // Phương thức xác thực và tạo bảng mới
    private async Task ValidateAndCreateTable()
    {
        var errors = new List<string>(); // Danh sách lỗi

        // Xác thực tên bảng
        if (string.IsNullOrWhiteSpace(newTable.Name))
        {
            errors.Add("Table name is required"); // Tên bảng là bắt buộc
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(newTable.Name, "^[a-zA-Z][a-zA-Z0-9_]*$"))
        {
            errors.Add("Invalid table name format"); // Tên bảng không hợp lệ
        }

        // Xác thực cột
        if (!newTable.Columns.Any())
        {
            errors.Add("At least one column is required"); // Ít nhất một cột là bắt buộc
        }

        foreach (var column in newTable.Columns)
        {
            // Xác thực tên cột
            if (string.IsNullOrWhiteSpace(column.Name))
            {
                errors.Add("Column name is required"); // Tên cột là bắt buộc
            }
            if (string.IsNullOrWhiteSpace(column.DataType))
            {
                errors.Add($"Data type is required for column {column.Name}"); // Kiểu dữ liệu là bắt buộc
            }

            // Chỉ kiểm tra MaxLength cho các kiểu dữ liệu yêu cầu độ dài
            if (lengthRequiredTypes.Contains(column.DataType?.ToLower()) && column.MaxLength <= 0)
            {
                errors.Add($"Length is required for {column.DataType} column {column.Name}"); // Độ dài là bắt buộc
            }

            // Xác thực khóa ngoại
            if (column.IsForeignKey)
            {
                if (string.IsNullOrEmpty(column.ForeignKeyTable))
                {
                    errors.Add($"Foreign key table must be selected for column {column.Name}"); // Bảng khóa ngoại là bắt buộc
                }
                if (string.IsNullOrEmpty(column.ForeignKeyColumn))
                {
                    errors.Add($"Foreign key column must be selected for column {column.Name}"); // Cột khóa ngoại là bắt buộc
                }
            }

            // Khóa chính không thể nullable
            if (column.IsPrimaryKey && column.IsNullable)
            {
                errors.Add($"Primary key column {column.Name} cannot be nullable"); // Khóa chính không thể nullable
            }
        }

        // Nếu có lỗi, hiển thị thông báo
        if (errors.Any())
        {
            await JSRuntime.InvokeVoidAsync("alert", string.Join("\n", errors));
            return;
        }

        await CreateTable(); // Tạo bảng nếu không có lỗi
    }

    // Phương thức lấy các cột khóa ngoại từ bảng
    private List<ColumnInfo> GetForeignKeyColumns(string tableFullName)
    {
        if (string.IsNullOrEmpty(tableFullName)) return new List<ColumnInfo>(); // Nếu không có tên bảng, trả về danh sách rỗng

        var parts = tableFullName.Split('.'); // Tách schema và tên bảng
        if (parts.Length != 2) return new List<ColumnInfo>(); // Nếu không đúng định dạng, trả về danh sách rỗng

        var schema = parts[0]; // Lưu schema
        var tableName = parts[1]; // Lưu tên bảng

        try
        {
            return TableService.GetColumnsAsync(selectedDatabase, schema, tableName).Result // Lấy danh sách cột
                .Where(c => c.IsPrimaryKey) // Chỉ lấy các cột là khóa chính
                .ToList();
        }
        catch
        {
            return new List<ColumnInfo>(); // Nếu có lỗi, trả về danh sách rỗng
        }
    }

    // Phương thức tạo bảng mới
    private async Task CreateTable()
    {
        try
        {
            await TableService.CreateTableAsync(selectedDatabase, newTable); // Gọi dịch vụ để tạo bảng
            await LoadTables(); // Tải lại danh sách bảng
            CloseModals(); // Đóng các modal
            await JSRuntime.InvokeVoidAsync("alert", "Table created successfully"); // Thông báo thành công
        }
        catch (Exception ex)
        {
            // Hiển thị thông báo lỗi nếu có
            await JSRuntime.InvokeVoidAsync("alert", $"Error creating table: {ex.Message}");
        }
    }

    // Phương thức xác nhận và xóa bảng
    private async Task ConfirmAndDeleteTable(TableInfo table)
    {
        // Hiển thị hộp thoại xác nhận trước khi xóa bảng
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            $"Are you sure you want to delete the table '{table.Schema}.{table.Name}'?\n" +
            $"This will permanently delete {table.RowCount} rows of data.");

        if (confirmed) // Nếu người dùng xác nhận
        {
            try
            {
                await TableService.DeleteTableAsync(selectedDatabase, table.Schema, table.Name); // Xóa bảng
                await LoadTables(); // Tải lại danh sách bảng
                await JSRuntime.InvokeVoidAsync("alert", "Table deleted successfully"); // Thông báo thành công
            }
            catch (Exception ex) // Bắt lỗi nếu có
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error deleting table: {ex.Message}"); // Thông báo lỗi
            }
        }
    }

    // Phương thức xóa cột
    private async Task DeleteColumn(string columnName)
    {
        // Hiển thị hộp thoại xác nhận trước khi xóa cột
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            $"Are you sure you want to delete the column '{columnName}'?");

        if (confirmed) // Nếu người dùng xác nhận
        {
            try
            {
                await TableService.DeleteColumnAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name,
                    columnName // Xóa cột
                );
                await ShowColumnsModal(selectedTable); // Tải lại danh sách cột
                await JSRuntime.InvokeVoidAsync("alert", "Column deleted successfully"); // Thông báo thành công
            }
            catch (Exception ex) // Bắt lỗi nếu có
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error deleting column: {ex.Message}"); // Thông báo lỗi
            }
        }
    }

    // Phương thức sắp xếp dữ liệu theo cột
    private async Task SortBy(string columnName)
    {
        // Đảo ngược thứ tự sắp xếp nếu cột đã được sắp xếp
        if (currentOrderBy == columnName)
        {
            currentOrderBy = $"{columnName} DESC"; // Sắp xếp giảm dần
        }
        else
        {
            currentOrderBy = columnName; // Sắp xếp tăng dần
        }
        await LoadTableData(); // Tải lại dữ liệu bảng
    }

    // Phương thức đóng các modal
    private void CloseModals()
    {
        showCreateModal = false; // Đóng modal tạo bảng
        showColumnsModal = false; // Đóng modal cột
        selectedTable = null; // Đặt bảng đã chọn về null
    }

    // Phương thức đóng modal dữ liệu
    private void CloseDataModals()
    {
        DataModal = false; // Đóng modal dữ liệu
    }

    // Phương thức xử lý thay đổi khóa ngoại
    private void OnForeignKeyChanged(ColumnInfo column)
    {
        if (!column.IsForeignKey) // Nếu không phải khóa ngoại
        {
            // Đặt lại các thuộc tính liên quan đến khóa ngoại
            column.ForeignKeyTable = null; // Đặt bảng khóa ngoại về null
            column.ForeignKeyColumn = null; // Đặt cột khóa ngoại về null
        }
    }

    // Phương thức khởi tạo thêm cột
    private void InitializeAddColumn()
    {
        editingColumn = new ColumnInfo(); // Khởi tạo cột mới
        isAddingColumn = true; // Đặt trạng thái thêm cột
        isEditingColumn = false; // Đặt trạng thái chỉnh sửa cột về false
    }

    // Phương thức khởi tạo chỉnh sửa cột
    private void InitializeEditColumn(ColumnInfo column)
    {
        editingColumn = new ColumnInfo // Khởi tạo cột đang chỉnh sửa
            {
                Name = column.Name,
                DataType = column.DataType,
                MaxLength = column.MaxLength,
                IsNullable = column.IsNullable,
                DefaultValue = column.DefaultValue
            };
        originalColumnName = column.Name; // Lưu tên cột gốc
        isEditingColumn = true; // Đặt trạng thái chỉnh sửa cột
        isAddingColumn = false; // Đặt trạng thái thêm cột về false
    }

    // Phương thức lưu thay đổi cột
    private async Task SaveColumnChanges()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(editingColumn.Name)) // Kiểm tra tên cột
            {
                await JSRuntime.InvokeVoidAsync("alert", "Column name is required"); // Thông báo lỗi
                return;
            }

            if (string.IsNullOrWhiteSpace(editingColumn.DataType)) // Kiểm tra kiểu dữ liệu
            {
                await JSRuntime.InvokeVoidAsync("alert", "Data type is required"); // Thông báo lỗi
                return;
            }

            // Kiểm tra độ dài nếu kiểu dữ liệu yêu cầu
            if (lengthRequiredTypes.Contains(editingColumn.DataType.ToLower()) && editingColumn.MaxLength <= 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Length is required for this data type"); // Thông báo lỗi
                return;
            }

            if (isAddingColumn) // Nếu đang thêm cột
            {
                await TableService.AddColumnAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name,
                    editingColumn // Thêm cột
                );
            }
            else // Nếu đang chỉnh sửa cột
            {
                await TableService.AlterColumnAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name,
                    originalColumnName,
                    editingColumn // Chỉnh sửa cột
                );
            }

            // Tải lại danh sách cột
            await ShowColumnsModal(selectedTable);
            CancelColumnEdit(); // Hủy chỉnh sửa cột
            await JSRuntime.InvokeVoidAsync("alert",
                isAddingColumn ? "Column added successfully" : "Column updated successfully"); // Thông báo thành công
        }
        catch (Exception ex) // Bắt lỗi nếu có
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}"); // Thông báo lỗi
        }
    }

    // Phương thức hủy chỉnh sửa cột
    private void CancelColumnEdit()
    {
        isAddingColumn = false; // Đặt trạng thái thêm cột về false
        isEditingColumn = false; // Đặt trạng thái chỉnh sửa cột về false
        editingColumn = new ColumnInfo(); // Khởi tạo cột mới
        originalColumnName = null; // Đặt tên cột gốc về null
    }

    // Phương thức xác nhận xóa cột
    private async Task ConfirmDeleteColumn(ColumnInfo column)
    {
        // Hiển thị hộp thoại xác nhận trước khi xóa cột
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete column {column.Name}?"))
        {
            try
            {
                await TableService.DeleteColumnAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name,
                    column.Name // Xóa cột
                );
                await ShowColumnsModal(selectedTable); // Tải lại danh sách cột
                await JSRuntime.InvokeVoidAsync("alert", "Column deleted successfully"); // Thông báo thành công
            }
            catch (Exception ex) // Bắt lỗi nếu có
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error deleting column: {ex.Message}"); // Thông báo lỗi
            }
        }
    }

    // Khai báo biến cho việc quản lý bản ghi
    private Dictionary<string, object> editingRecord; // Bản ghi đang chỉnh sửa
    private Dictionary<string, object> originalRecord; // Bản ghi gốc để so sánh
    private bool showRecordModal = false; // Trạng thái hiển thị modal bản ghi
    private bool isEditingRecord = false; // Trạng thái chỉnh sửa bản ghi

    // Phương thức khởi tạo thêm bản ghi
    private async Task InitializeAddRecord()
    {
        try
        {
            // Tải danh sách cột trước khi hiển thị modal
            tableColumns = await TableService.GetColumnsAsync(
                selectedDatabase,
                selectedTable.Schema,
                selectedTable.Name
            );

            // Khởi tạo dictionary trống cho bản ghi mới
            editingRecord = new Dictionary<string, object>();
            foreach (var column in tableColumns) // Duyệt qua từng cột
            {
                editingRecord[column.Name] = null; // Đặt giá trị ban đầu là null
            }

            isEditingRecord = false; // Đặt trạng thái chỉnh sửa bản ghi về false
            showRecordModal = true; // Hiển thị modal bản ghi
            StateHasChanged(); // Cập nhật trạng thái UI
        }
        catch (Exception ex) // Bắt lỗi nếu có
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error initializing add form: {ex.Message}"); // Thông báo lỗi
        }
    }

    // Phương thức khởi tạo chỉnh sửa bản ghi
    private async Task InitializeEditRecord(Dictionary<string, object> record)
    {
        try
        {
            // Tải danh sách cột trước khi hiển thị modal
            tableColumns = await TableService.GetColumnsAsync(
                selectedDatabase,
                selectedTable.Schema,
                selectedTable.Name
            );

            // Khởi tạo bản ghi đang chỉnh sửa và lưu bản ghi gốc
            editingRecord = new Dictionary<string, object>(record);
            originalRecord = new Dictionary<string, object>(record);
            isEditingRecord = true; // Đặt trạng thái chỉnh sửa bản ghi
            showRecordModal = true; // Hiển thị modal bản ghi
            StateHasChanged(); // Cập nhật trạng thái UI
        }
        catch (Exception ex) // Bắt lỗi nếu có
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error initializing edit form: {ex.Message}"); // Thông báo lỗi
        }
    }

    // Phương thức lưu bản ghi (cập nhật hoặc thêm mới)
    private async Task SaveRecord()
    {
        try
        {
            if (isEditingRecord) // Nếu đang chỉnh sửa bản ghi
            {
                await TableService.UpdateRecordAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name,
                    editingRecord, // Bản ghi đang chỉnh sửa
                    originalRecord // Bản ghi gốc để so sánh
                );
            }
            else // Nếu đang thêm mới bản ghi
            {
                await TableService.InsertRecordAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name,
                    editingRecord // Bản ghi mới
                );
            }

            showRecordModal = false; // Đóng modal bản ghi
            await LoadTableData(); // Tải lại dữ liệu sau khi lưu
        }
        catch (Exception ex) // Bắt lỗi nếu có
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving record: {ex.Message}"); // Thông báo lỗi
        }
    }

    // Phương thức xóa bản ghi
    private async Task DeleteRecord(Dictionary<string, object> record)
    {
        try
        {
            // Hiển thị hộp thoại xác nhận trước khi xóa bản ghi
            if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this record?"))
            {
                await TableService.DeleteRecordAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name,
                    record // Bản ghi cần xóa
                );
                await LoadTableData(); // Tải lại dữ liệu sau khi xóa
            }
        }
        catch (Exception ex) // Bắt lỗi nếu có
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error deleting record: {ex.Message}"); // Thông báo lỗi
        }
    }

    // Phương thức chuyển đổi hàng dữ liệu thành dictionary
    private Dictionary<string, object> ConvertRowToDictionary(List<object> row, List<string> columns)
    {
        var dictionary = new Dictionary<string, object>();

        // Duyệt qua từng cột và thêm vào dictionary
        for (int i = 0; i < columns.Count; i++)
        {
            var value = row[i];
            dictionary[columns[i]] = value == DBNull.Value ? null : value; // Kiểm tra giá trị DBNull
        }

        return dictionary; // Trả về dictionary chứa dữ liệu
    }

    // Phương thức khởi tạo chỉnh sửa bản ghi từ hàng dữ liệu
    private async Task InitializeEditRecord(List<object> row)
    {
        try
        {
            // Tải danh sách cột nếu chưa có
            if (tableColumns == null)
            {
                tableColumns = await TableService.GetColumnsAsync(
                    selectedDatabase,
                    selectedTable.Schema,
                    selectedTable.Name
                );
            }

            // Lấy danh sách tên cột
            var columnNames = tableColumns.Select(c => c.Name).ToList();

            // Chuyển đổi hàng dữ liệu thành dictionary
            editingRecord = ConvertRowToDictionary(row, columnNames);
            originalRecord = new Dictionary<string, object>(editingRecord); // Lưu bản ghi gốc

            isEditingRecord = true; // Đặt trạng thái chỉnh sửa bản ghi
            showRecordModal = true; // Hiển thị modal bản ghi
            StateHasChanged(); // Cập nhật trạng thái UI
        }
        catch (Exception ex) // Bắt lỗi nếu có
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error initializing edit form: {ex.Message}"); // Thông báo lỗi
        }
    }


}
